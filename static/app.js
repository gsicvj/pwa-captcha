let birthdays = null;
const STORAGE_KEY = "birthdays";

const errorMessage = document.getElementById("error-message");

const birthdaySection = document.getElementById("birthday-section");
let birthdayList = null;

const form = document.querySelector("form");

function getBirthdays() {
  if (birthdays === null) {
    birthdays = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  }
  return birthdays;
}

function createBirthdayElement(name, birthday) {
  const formattedBirthday = formatBirthday(birthday);
  const li = document.createElement("li");
  const infoDiv = document.createElement("div");
  infoDiv.className = "info";
  const nameSpan = document.createElement("span");
  nameSpan.textContent = name;
  const birthdaySpan = document.createElement("span");
  birthdaySpan.textContent = formattedBirthday;
  const button = document.createElement("button");
  button.type = "button";
  button.className = "icon";
  button.textContent = "Ã—";
  button.addEventListener("click", function () {
    removeBirthday(this);
    if (birthdayList.children.length === 0) {
      birthdayList.innerHTML = "<p>No birthdays to display</p>";
    }
  });
  infoDiv.appendChild(nameSpan);
  infoDiv.appendChild(birthdaySpan);
  li.appendChild(infoDiv);
  li.appendChild(button);
  return li;
}

function addBirthday(name, birthday) {
  if (!validateBirthday(birthday)) {
    errorMessage.textContent = "Invalid birthday";
    return;
  }
  if (birthdays.some((birthday) => birthday.name === name)) {
    errorMessage.textContent = "Birthday already exists";
    return;
  }
  if (birthdays.length === 0) {
    birthdayList.innerHTML = "";
  }

  birthdays.push({ name, birthday });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(birthdays));
  const birthdayElement = createBirthdayElement(name, birthday);
  birthdayList.appendChild(birthdayElement);
}

function removeBirthday(element) {
  const li = element.parentElement;
  const name = li.querySelector("span:first-child").textContent;
  birthdays = birthdays.filter((birthday) => birthday.name !== name);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(birthdays));
  li.remove();
  showNotification(
    "Birthday removed",
    `${name} has been removed from the list`
  );
}

function pushNotification(title, body) {
  // Ask the server to send the client a notification (for testing purposes, in actual
  // applications the push notification is likely going to be generated by some event
  // in the server).
  fetch("/sendNotification", {
    method: "post",
    headers: {
      "Content-type": "application/json",
    },
    body: JSON.stringify({ title, body }),
  });
}

function renderBirthdays(birthdays) {
  if (!birthdayList) {
    birthdayList = document.createElement("ul");
    birthdayList.className = "birthday-list";
    birthdaySection.appendChild(birthdayList);
  }
  if (birthdays.length === 0) {
    birthdayList.innerHTML = "<p>No birthdays to display</p>";
    return;
  }
  birthdayList.innerHTML = "";
  const birthdaysFragment = document.createDocumentFragment();
  birthdays.forEach((birthday) => {
    birthdaysFragment.appendChild(
      createBirthdayElement(birthday.name, birthday.birthday)
    );
  });
  birthdayList.appendChild(birthdaysFragment);
}

function validateBirthday(birthday) {
  const date = new Date(birthday);
  const today = new Date();
  return !isNaN(date.getTime()) && date <= today;
}

function formatBirthday(birthday) {
  const date = new Date(birthday);
  const options = { day: "numeric", month: "long", year: "numeric" };
  return date.toLocaleDateString("en-US", options);
}

function showNotification(title, body) {
  console.log("Showing notification", title, body);
  Notification.requestPermission().then((result) => {
    if (result === "granted") {
      new Notification(title, {
        body,
      });
    }
  });
}

function main() {
  const data = getBirthdays();
  renderBirthdays(data);

  // Add event listener to form
  form.addEventListener("submit", (event) => {
    event.preventDefault();
    const name = document.getElementById("name").value;
    const birthday = document.getElementById("birthday").value;
    addBirthday(name, birthday);
    form.reset();
    errorMessage.textContent = "";
    showNotification("Birthday added", `${name} has a birthday on ${birthday}`);
  });
}

main();
